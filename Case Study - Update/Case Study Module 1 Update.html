<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>[*Bài tập] Phát triển game lái xe</title>
    <style>
        body {
            margin: 0;
            position: relative;
            width: 100vw;
            height: 100vh;
            background-color: #000000;
        }
        canvas {
            border: 1px solid #000000;
            border-left-color: grey;
            border-right-color: grey;
            position: absolute;
            left: 50%;
            transform: translate(-50%);
        }
        #startButton {
            position: absolute;
            left: 15%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 50px;
            font-size: 25px;
            text-align: center;
        }
        div {
            position: absolute;
            left: 85%;
            top: 25%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 150px;
            font-size: 50px;
            text-align: center;
            color: blue;
        }
    </style>
</head>
<body onkeydown="gameBoard.moveCar(event)">
<canvas></canvas>
<button id="startButton" type="button" onclick="reStart()">START</button>
<div></div>
<script>
    let canvas = document.querySelector("canvas");
    let context = canvas.getContext("2d");
    canvas.width = window.innerWidth / 3;
    canvas.height = window.innerHeight * 99.2 / 100;
    const CW = canvas.width;
    const CH = canvas.height;
    function Road() {
        this.road = new Image();
        this.draw = function () {
            context.drawImage(this.road, 0, 0, CW, CH);
            this.road.src = "./image/road.png";
        }
    }
    function RoadLane() {
        this.width = CW * 0.02;
        this.height = CH * 0.075;
        this.x1 = CW * 0.05 + CW * 0.9 / 3 - this.width / 2;
        this.x2 = CW * 0.05 + CW * 0.9 / 3 * 2 - this.width / 2;
        this.y = -12 * this.height;
        this.speed = speed;
        this.move = function () {
            if (this.y >= CH) {
                this.y = -this.height;
            } else {
                this.y += this.speed;
            }
        }
        this.draw = function () {
            context.fillStyle = "#ffffff";
            context.fillRect(this.x1, this.y, this.width, this.height);
            context.fillRect(this.x1, this.y + 2 * this.height, this.width, this.height);
            context.fillRect(this.x1, this.y + 4 * this.height, this.width, this.height);
            context.fillRect(this.x1, this.y + 6 * this.height, this.width, this.height);
            context.fillRect(this.x1, this.y + 8 * this.height, this.width, this.height);
            context.fillRect(this.x1, this.y + 10 * this.height, this.width, this.height);
            context.fillRect(this.x1, this.y + 12 * this.height, this.width, this.height);
            context.fillRect(this.x2, this.y, this.width, this.height);
            context.fillRect(this.x2, this.y + 2 * this.height, this.width, this.height);
            context.fillRect(this.x2, this.y + 4 * this.height, this.width, this.height);
            context.fillRect(this.x2, this.y + 6 * this.height, this.width, this.height);
            context.fillRect(this.x2, this.y + 8 * this.height, this.width, this.height);
            context.fillRect(this.x2, this.y + 10 * this.height, this.width, this.height);
            context.fillRect(this.x2, this.y + 12 * this.height, this.width, this.height);
            this.move();
        }
    }
    function Car() {
        this.car = new Image();
        this.width = CW * 0.11;
        this.height = CH * 0.15;
        this.x = (CW - this.width) / 2;
        this.y = CH - this.height;
        this.speed = speedCar;
        this.draw = function () {
            context.drawImage(this.car, this.x, this.y, this.width, this.height);
            this.car.src = "./image/car.png";
        }
    }
    function Stone() {
        this.image = new Image()
        this.collisionAudio = new Audio("audio/collision.mp3");
        this.width = CW * 0.15;
        this.height = CH * 0.062;
        this.x = Math.floor(Math.random() * (CW - this.width));
        this.y = -this.height;
        this.speed = speed;
        this.move = function () {
            if (this.y >= CH) {
                this.x = Math.floor(Math.random() * (CW - this.width));
                this.y = -this.height;
            } else {
                this.y += this.speed;
            }
        }
        this.checkCollision = function (car, gameBoard) {
            /*
            Điều kiện if bên dưới là thuật toán xét va chạm giữa 2 hình chữ nhật ( xe car và hòn đá )
            https://techmaster.vn/posts/35809/thuat-toan-kiem-tra-2-hinh-chu-nhat-co-giao-nhau-khong
            đừng copy thuật toán của link phía trên vì nó bị sai, soi mãi mới biết chỗ để sửa
            sau đó tự nhân chia thêm để xét va chạm chi tiết hơn, tránh các vùng trống xung quanh của hình ảnh
            */
            if ((this.x + this.width * 0.25) + this.width * 0.5 >= (car.x + car.width * 0.1)
                && (car.x + car.width * 0.1) + car.width * 0.8 >= (this.x + this.width * 0.25)
                && (this.y + this.height * 0.1) + this.height * 0.8 >= (car.y + car.height * 0.1)
                && (car.y + car.height * 0.1) + car.height * 0.8 >= (this.y + this.height * 0.1)) {
                this.collisionAudio.play();
                gameBoard.getGameOver();
                clearLoopRender();
            }
        }
        this.draw = function (car, gameBoard) {
            context.drawImage(this.image, this.x, this.y, this.width, this.height);
            this.image.src = "./image/stone.png";
            this.checkCollision(car, gameBoard);
            this.move();
        }
    }
    function Coin() {
        this.image = new Image();
        this.width = CH * 0.062;
        this.height = CH * 0.062;
        this.x = Math.floor(Math.random() * (CW - this.width));
        this.y = -this.height;
        this.y2 = CH - this.y;
        this.speed = speed;
        this.hide = function () {
            this.y = this.y2;
        }
        this.move = function () {
            if (this.y >= CH) {
                this.x = Math.floor(Math.random() * (CW - this.width));
                this.y = -this.height;
            } else {
                this.y += this.speed;
            }
        }
        this.checkCollision = function (car, gameBoard) {
            if (this.x + this.width >= car.x && car.x + car.width >= this.x
                && this.y + this.height >= car.y && car.y + car.height >= this.y) {
                gameBoard.bonus();
                this.hide();
            }
        }
        this.draw = function (car, gameBoard) {
            context.drawImage(this.image, this.x, this.y, this.width, this.height);
            this.image.src = "./image/coin.png";
            this.checkCollision(car, gameBoard);
            this.move();
        }
    }
    function GameBoard() {
        this.car = new Car();
        this.road = new Road();
        this.audioEngine = new Audio("audio/engine.mp3");
        this.audioRelax = new Audio("audio/relax.mp3");
        this.audioBonus = new Audio("audio/bonus.mp3");
        this.audioGameOver = new Audio("audio/game-over.mp3");
        this.score = 0;
        this.highScore = [0, 1000];
        this.render = function () {
            context.clearRect(0, 0, CW, CH);
            this.road.draw();
        }
        this.getScore = function () {
            this.audioEngine.play();
            this.audioEngine.loop = true;
            this.audioRelax.play();
            this.audioRelax.loop = true;
            this.score += 0.5;
            context.font = `${CW * 0.08}px Georgia`;
            context.fillStyle = "red";
            context.fillText(`${Math.floor(this.score)}`, CW * 0.06, CH * 0.05);
        }
        this.bonus = function () {
            this.audioBonus.play();
            this.score += 100;
        }
        this.getGameOver = function () {
            this.audioEngine.src = "";
            this.audioRelax.src = "";
            this.audioGameOver.play();
            this.highScore.push(Math.floor(this.score + 0.5));
            this.highScore.sort(function(a,b){return b-a});
            document.querySelector("div").innerHTML = `High Score<br>${this.highScore[0]}`;
            context.beginPath();
            context.font = "75px Georgia";
            context.textAlign = "center";
            context.fillStyle = "red";
            context.fillText(`Game Over`, CW / 2, CH / 2 - 40);
            context.font = "35px Georgia";
            context.fillText(`Your Scores: ${Math.floor(this.score + 0.5)}`, CW / 2, CH / 2 + 40);
        }
        this.checkCollision = function () {
            if (this.car.x+this.car.width <= 0 || this.car.x >= CW
                || this.car.y+this.car.height <= 0 || this.car.y >= CH) {
                this.getGameOver();
                clearLoopRender();
            }
        }
        this.moveCar = function (event) {
            switch (event.which) {
                case 37:
                    this.car.x -= this.car.speed;
                    break;
                case 38:
                    this.car.y -= this.car.speed;
                    break;
                case 39:
                    this.car.x += this.car.speed;
                    break;
                case 40:
                    this.car.y += this.car.speed;
                    break;
                case 17:
                    this.car.speed = speedCar * 3;
                    break;
                case 16:
                    this.car.speed = speedCar;
                    break;
            }
        }
    }
    let interval, gameBoard;
    let stone = [];
    let coin = [];
    let roadLane = [];
    let timeoutCoin1, timeoutCoin2, timeoutCoin3, timeoutCoin4, timeoutCoin5;
    let timeoutStone1, timeoutStone2, timeoutStone3, timeoutStone4;
    let speed = CH * 0.005;
    let speedCar = CH * 0.006;
    function clearLoopRender() {
        clearInterval(interval);
        clearTimeout(timeoutCoin1);
        clearTimeout(timeoutCoin2);
        clearTimeout(timeoutCoin3);
        clearTimeout(timeoutCoin4);
        clearTimeout(timeoutCoin5);
        clearTimeout(timeoutStone1);
        clearTimeout(timeoutStone2);
        clearTimeout(timeoutStone3);
        clearTimeout(timeoutStone4);
    }
    function reStart () {
        clearLoopRender();
        context.clearRect(0, 0, CW, CH);
        stone = [];
        coin = [];
        roadLane = [];
        speed = CH * 0.005;
        speedCar = CH * 0.006;
        start();
    }
    function start() {
        gameBoard = new GameBoard();
        stone.push(new Stone());
        roadLane.push(new RoadLane());
        roadLane[0].y = 0;
        interval = setInterval(function () {
            gameBoard.render();
            roadLane[0].draw();
            roadLane[0].speed += CH * 0.005 * 0.005;
            if (typeof roadLane[1] === "object") roadLane[1].draw();
            if (typeof roadLane[1] === "object") roadLane[1].speed = roadLane[0].speed;
            if (typeof roadLane[2] === "object") roadLane[2].draw();
            if (typeof roadLane[2] === "object") roadLane[2].speed = roadLane[0].speed;
            if (typeof coin[0] === "object") coin[0].draw(gameBoard.car, gameBoard);
            if (typeof coin[0] === "object") coin[0].speed = roadLane[0].speed;
            if (typeof coin[1] === "object") coin[1].draw(gameBoard.car, gameBoard);
            if (typeof coin[1] === "object") coin[1].speed = roadLane[0].speed;
            if (typeof coin[2] === "object") coin[2].draw(gameBoard.car, gameBoard);
            if (typeof coin[2] === "object") coin[2].speed = roadLane[0].speed;
            if (typeof coin[3] === "object") coin[3].draw(gameBoard.car, gameBoard);
            if (typeof coin[3] === "object") coin[3].speed = roadLane[0].speed;
            if (typeof coin[4] === "object") coin[4].draw(gameBoard.car, gameBoard);
            if (typeof coin[4] === "object") coin[4].speed = roadLane[0].speed;
            stone[0].draw(gameBoard.car, gameBoard);
            stone[0].speed = roadLane[0].speed;
            if (typeof stone[1] === "object") stone[1].draw(gameBoard.car, gameBoard);
            if (typeof stone[1] === "object") stone[1].speed = roadLane[0].speed;
            if (typeof stone[2] === "object") stone[2].draw(gameBoard.car, gameBoard);
            if (typeof stone[2] === "object") stone[2].speed = roadLane[0].speed;
            if (typeof stone[3] === "object") stone[3].draw(gameBoard.car, gameBoard);
            if (typeof stone[3] === "object") stone[3].speed = roadLane[0].speed;
            if (typeof stone[4] === "object") stone[4].draw(gameBoard.car, gameBoard);
            if (typeof stone[4] === "object") stone[4].speed = roadLane[0].speed;
            gameBoard.car.draw();
            gameBoard.car.speed = roadLane[0].speed;
            gameBoard.checkCollision();
            gameBoard.getScore();
        }, 50);
        timeoutCoin1 = setTimeout(function () {
            coin.push(new Coin());
        }, 2000)
        timeoutCoin2 = setTimeout(function () {
            coin.push(new Coin());
        }, 6000)
        timeoutCoin3 = setTimeout(function () {
            coin.push(new Coin());
        }, 10000)
        timeoutCoin4 = setTimeout(function () {
            coin.push(new Coin());
        }, 14000)
        timeoutCoin5 = setTimeout(function () {
            coin.push(new Coin());
        }, 18000)
        timeoutStone1 = setTimeout(function () {
            stone.push(new Stone());
            roadLane.push(new RoadLane());
        }, 4000);
        timeoutStone2 = setTimeout(function () {
            stone.push(new Stone());
            roadLane.push(new RoadLane());
        }, 8000);
        timeoutStone3 = setTimeout(function () {
            stone.push(new Stone());
        }, 12000);
        timeoutStone4 = setTimeout(function () {
            stone.push(new Stone());
        }, 16000);
    }
</script>
</body>
</html>