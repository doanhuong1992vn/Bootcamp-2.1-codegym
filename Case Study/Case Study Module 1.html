<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>[*Bài tập] Phát triển game lái xe</title>
    <style>
        body {
            margin: 0;
            position: relative;
            background-color: #000000;
        }

        canvas {
            border: 1px solid #000000;
            border-left-color: grey;
            border-right-color: grey;
            position: absolute;
            left: 50%;
            transform: translate(-50%);
        }
    </style>
</head>
<body onkeydown="gameBoard.moveCar(event)">
<canvas></canvas>

<script>
    let canvas = document.querySelector("canvas");
    canvas.width = window.innerWidth / 3;
    canvas.height = window.innerHeight * 99.2 / 100;
    let context = canvas.getContext("2d");
    let score = 0;

    function Car() {
        this.car = new Image();
        this.width = 46.5;
        this.height = 95.5;
        this.x = (canvas.width - this.width) / 2;
        this.y = canvas.height - this.height;
        this.speed = 3;
        this.orientation = "up";
        this.draw = function () {
            context.drawImage(this.car, this.x, this.y, this.width, this.height);
            this.car.src = "./image/car.png";
        }
        this.move = function () {
            switch (this.orientation) {
                case "up":
                    this.y -= this.speed;
                    break;
                case "down":
                    this.y += this.speed;
                    break;
                case "left":
                    this.x -= this.speed;
                    break;
                case "right":
                    this.x += this.speed;
                    break;
            }
        }
    }

    function Stone() {
        this.image = new Image()
        this.width = 96.875;
        this.height = 60;
        this.x = Math.floor(Math.random() * (canvas.width - this.width));
        this.y = -this.height;
        this.speed = 5;
        this.draw = function () {
            context.drawImage(this.image, this.x, this.y, this.width, this.height);
            this.image.src = "./image/stone.png";
        }
        this.move = function () {
            if (this.y >= canvas.height) {
                this.x = Math.floor(Math.random() * (canvas.width - this.width));
                this.y = -this.height;
            } else {
                this.y += this.speed;
            }
        }
        this.checkCollision = function (car, gameBoard) {
            /*
            Điều kiện if bên dưới là thuật toán xét va chạm giữa 2 hình chữ nhật ( xe car và hòn đá )
            https://techmaster.vn/posts/35809/thuat-toan-kiem-tra-2-hinh-chu-nhat-co-giao-nhau-khong
            đừng copy thuật toán của link phía trên vì nó bị sai, soi mãi mới biết chỗ để sửa
            */
            if (this.x + this.width >= car.x && car.x + car.width >= this.x
                && this.y + this.height >= car.y && car.y + car.height >= this.y)
            {
                gameBoard.getGameOver();
                clearInterval(interval);
                clearTimeout(timeout1);
                clearTimeout(timeout2);
            }
        }
    }

    function Road() {
        this.road = new Image();
        this.draw = function () {
            context.drawImage(this.road, 0, 0, canvas.width, canvas.height);
            this.road.src = "./image/road.png";
        }
    }

    function GameBoard() {
        this.car = new Car();
        this.road = new Road();
        this.render = function () {
            context.clearRect(0, 0, canvas.width, canvas.height);
            this.road.draw();
            this.car.draw();
        }
        this.getGameOver = function () {
            context.beginPath();
            context.font = "75px Georgia";
            context.textAlign = "center";
            context.fillStyle = "red";
            context.fillText(`Game Over`, canvas.width / 2, canvas.height/2-40);
            context.font = "35px Georgia";
            context.fillText(`Your Scores: ${score}`, canvas.width / 2, canvas.height/2+40);
        }
        this.checkCollision = function () {
            if (this.car.x <= 0 || this.car.x + this.car.width >= canvas.width
                || this.car.y <= 0 || this.car.y >= canvas.height)
            {
                this.getGameOver();
                clearInterval(interval);
                clearTimeout(timeout1);
                clearTimeout(timeout2);
            }
        }
        this.moveCar = function (event) {
            switch (event.which) {
                case 37:
                    this.car.orientation = "left";
                    break;
                case 38:
                    this.car.orientation = "up";
                    break;
                case 39:
                    this.car.orientation = "right";
                    break;
                case 40:
                    this.car.orientation = "down";
                    break;
                case 17:
                    this.car.speed = 8;
                    break;
                case 16:
                    this.car.speed = 3;
                    break;
            }
            this.car.move();
        }
    }

    let gameBoard = new GameBoard();

    let interval = setInterval(function () {
        gameBoard.render();
        stone1.draw();
        gameBoard.checkCollision();
        stone1.checkCollision(gameBoard.car, gameBoard);
        stone1.move();
        score += 1;
    }, 100)
    let stone2, stone3;
    let stone1 = new Stone();
    let timeout1 = setTimeout(function () {
        stone2 = new Stone();
        clearInterval(interval);
        interval = setInterval(function () {
            gameBoard.render();
            stone1.draw();
            stone2.draw();
            gameBoard.checkCollision();
            stone1.checkCollision(gameBoard.car, gameBoard);
            stone2.checkCollision(gameBoard.car, gameBoard);
            stone1.move();
            stone2.move();
            score += 1;
        }, 100)
    }, 4000);
    let timeout2 = setTimeout(function () {
        stone3 = new Stone();
        clearInterval(interval);
        interval = setInterval(function () {
            gameBoard.render();
            stone1.draw();
            stone2.draw();
            stone3.draw();
            gameBoard.checkCollision();
            stone1.checkCollision(gameBoard.car, gameBoard);
            stone2.checkCollision(gameBoard.car, gameBoard);
            stone3.checkCollision(gameBoard.car, gameBoard);
            stone1.move();
            stone2.move();
            stone3.move();
            score += 1;
        }, 100)
    }, 8000);
</script>
</body>
</html>