<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Game Escape Methamphetamine</title>
    <link rel="stylesheet" href="style/style.css">
</head>
<body onkeydown="gameBoard.car.move(event)">
<canvas></canvas>
<img id="logo" src="image/logo.png" alt="Logo Image">
<p id="instruct">HƯỚNG DẪN</p>
<img id="image" src="./image/instruct.png" alt="instruct image">
<ul id="rule">
    <li>Trụ 1 giây được 10 điểm</li>
    <li>Chạm đồng xu được 100 điểm</li>
    <li>Đâm vào đá hoặc ra ngoài đường đua thì thua</li>
</ul>
<p id="challenge">Bạn sẽ trụ được bao lâu?</p>
<div id="highScore">High Score<br>1408</div>
<img id="background" src="image/background.png" alt="Road Background">
<img id="startImg" src="image/startBtn.png" onclick="reStart()" alt="Start Button">
<script>
    let canvas = document.querySelector("canvas");
    let context = canvas.getContext("2d");
    canvas.width = window.innerWidth / 3;
    canvas.height = window.innerHeight * 99.2 / 100;
    const CW = canvas.width;
    const CH = canvas.height;
    let roadBg = document.querySelector("#background");
    roadBg.width = CW;
    roadBg.height = CH;
    let startImg = document.querySelector("#startImg");
    startImg.width = CW / 4;
    startImg.height = CW / 4;
    let logo = document.querySelector("#logo");
    logo.width = CW;
    logo.height = CH/10;
    function Road() {
        this.road = new Image();
        this.road.src = "./image/road.png";
        this.draw = function () {
            context.drawImage(this.road, 0, 0, CW, CH);
        }
    }
    function RoadLane(y) {
        this.width = CW * 0.02;
        this.height = CH / 13;
        this.x1 = CW * 0.05 + CW * 0.9 / 3 - this.width / 2;
        this.x2 = CW * 0.05 + CW * 0.9 / 3 * 2 - this.width / 2;
        this.y = y;
        this.speed = speed;
        this.setSpeed = function (speed) {
            this.speed = speed;
        }
        this.move = function () {
            if (this.y >= CH) {
                this.y = -this.height;
            } else {
                this.y += this.speed;
            }
        }
        this.draw = function (speed) {
            context.fillStyle = "#ffffff";
            context.fillRect(this.x1, this.y, this.width, this.height);
            context.fillRect(this.x2, this.y, this.width, this.height);
            this.move();
            this.setSpeed(speed);
        }
    }
    function Car() {
        this.image = new Image();
        this.image.src = "./image/car.png";
        this.width = CW * 0.11;
        this.height = CH * 0.15;
        this.x = (CW - this.width) / 2;
        this.y = CH - this.height;
        this.speed = 2 * speed;
        this.setSpeed = function (speed) {
            if (this.speed < 1.5 * this.width) this.speed = 2 * speed;
        }
        this.draw = function () {
            context.drawImage(this.image, this.x, this.y, this.width, this.height);
        }
        this.move = function (event) {
            switch (event.which) {
                case 37:
                    this.x -= this.speed;
                    break;
                case 38:
                    this.y -= this.speed;
                    break;
                case 39:
                    this.x += this.speed;
                    break;
                case 40:
                    this.y += this.speed;
                    break;
            }
        }
    }
    function Stone() {
        this.image = new Image()
        this.image.src = "./image/stone.png";
        this.collisionAudio = new Audio("audio/collision.mp3");
        this.width = CW * 0.15;
        this.height = CH * 0.062;
        this.x = Math.floor(Math.random() * (CW - this.width));
        this.y = -this.height;
        this.speed = speed;
        this.setSpeed = function (speed) {
            this.speed = speed;
        }
        this.move = function () {
            if (this.y >= CH) {
                this.x = Math.floor(Math.random() * (CW - this.width));
                this.y = -this.height;
            } else {
                this.y += this.speed;
            }
        }
        this.checkCollision = function (car, gameBoard) {
            if ((this.x + this.width * 0.25) + this.width * 0.5 >= (car.x + car.width * 0.1)
                && (car.x + car.width * 0.1) + car.width * 0.8 >= (this.x + this.width * 0.25)
                && (this.y + this.height * 0.1) + this.height * 0.8 >= (car.y + car.height * 0.1)
                && (car.y + car.height * 0.1) + car.height * 0.8 >= (this.y + this.height * 0.1))
            {
                this.collisionAudio.play();
                car.image.src = "./image/accident1.png";
                gameBoard.getGameOver();
                clearLoopRender();
            }
        }
        this.draw = function (car, gameBoard, speed) {
            context.drawImage(this.image, this.x, this.y, this.width, this.height);
            this.checkCollision(car, gameBoard);
            this.move();
            this.setSpeed(speed);
        }
    }
    function Coin() {
        this.image = new Image();
        this.width = CH * 0.062;
        this.height = CH * 0.062;
        this.x = Math.floor(Math.random() * (CW - this.width));
        this.y = -this.height;
        this.y2 = CH - this.y;
        this.speed = speed;
        this.image.src = "./image/coin.png";
        this.setSpeed = function (speed) {
            this.speed = speed;
        }
        this.hide = function () {
            this.y = this.y2;
        }
        this.move = function () {
            if (this.y >= CH) {
                this.x = Math.floor(Math.random() * (CW - this.width));
                this.y = -this.height;
            } else {
                this.y += this.speed;
            }
        }
        this.checkCollision = function (car, gameBoard) {
            if (this.x + this.width >= car.x && car.x + car.width >= this.x
                && this.y + this.height >= car.y && car.y + car.height >= this.y) {
                gameBoard.bonus();
                this.hide();
            }
        }
        this.draw = function (car, gameBoard, speed) {
            context.drawImage(this.image, this.x, this.y, this.width, this.height);
            this.checkCollision(car, gameBoard);
            this.move();
            this.setSpeed(speed);
        }
    }
    function GameBoard() {
        this.car = new Car();
        this.road = new Road();
        this.audioEngine = new Audio("audio/engine.mp3");
        this.audioRelax = new Audio("audio/relax.mp3");
        this.audioBonus = new Audio("audio/bonus.mp3");
        this.audioGameOver = new Audio("audio/game-over.mp3");
        this.score = 0;
        this.highScore = [0, 1408];
        this.getScore = function () {
            this.audioEngine.play();
            this.audioEngine.loop = true;
            this.audioRelax.play();
            this.audioRelax.loop = true;
            this.score += 0.5;
            context.font = `${CW * 0.08}px Georgia`;
            context.fillStyle = "red";
            context.textAlign = "left";
            context.fillText(`${Math.floor(this.score)}`, CW * 0.06, CH * 0.05);
        }
        this.bonus = function () {
            this.audioBonus.play();
            this.score += 100;
        }
        this.getGameOver = function () {
            // this.car.drawAccident();
            this.audioEngine.src = "";
            this.audioRelax.src = "";
            this.audioGameOver.play();
            this.highScore.push(Math.floor(this.score + 0.5));
            this.highScore.sort(function (a, b) {
                return b - a
            });
            document.querySelector("#highScore").innerHTML = `High Score<br>${this.highScore[0]}`;
            context.font = "75px Georgia";
            context.textAlign = "center";
            context.fillStyle = "red";
            context.fillText(`Game Over`, CW / 2, CH / 2 - 40);
            context.font = "35px Georgia";
            context.fillText(`Your Scores: ${Math.floor(this.score + 0.5)}`, CW / 2, CH / 2 + 40);
            startImg.style.display = "block";
        }
        this.checkCollision = function () {
            if (this.car.x + this.car.width <= 0 || this.car.x >= CW
                || this.car.y + this.car.height <= 0 || this.car.y >= CH) {
                this.getGameOver();
                clearLoopRender();
            }
        }
    }
    let interval, gameBoard;
    let stone = [];
    let coin = [];
    let roadLane = [];
    let timeoutCoin1, timeoutCoin2, timeoutCoin3, timeoutCoin4, timeoutCoin5;
    let timeoutStone1, timeoutStone2, timeoutStone3, timeoutStone4;
    let speed = CH * 0.005;
    function clearLoopRender() {
        clearInterval(interval);
        clearTimeout(timeoutCoin1);
        clearTimeout(timeoutCoin2);
        clearTimeout(timeoutCoin3);
        clearTimeout(timeoutCoin4);
        clearTimeout(timeoutCoin5);
        clearTimeout(timeoutStone1);
        clearTimeout(timeoutStone2);
        clearTimeout(timeoutStone3);
        clearTimeout(timeoutStone4);
    }
    function start() {
        gameBoard = new GameBoard();
        stone.push(new Stone());
        roadLane.push(
            new RoadLane(CH - CH / 13),
            new RoadLane(CH - 3 * CH / 13),
            new RoadLane(CH - 5 * CH / 13),
            new RoadLane(CH - 7 * CH / 13),
            new RoadLane(CH - 9 * CH / 13),
            new RoadLane(CH - 11 * CH / 13),
            new RoadLane(0),
        );
        timeoutCoin1 = setTimeout(function () {
            coin.push(new Coin());
        }, 2000)
        timeoutCoin2 = setTimeout(function () {
            coin.push(new Coin());
        }, 6000)
        timeoutCoin3 = setTimeout(function () {
            coin.push(new Coin());
        }, 10000)
        timeoutCoin4 = setTimeout(function () {
            coin.push(new Coin());
        }, 14000)
        timeoutCoin5 = setTimeout(function () {
            coin.push(new Coin());
        }, 18000)
        timeoutStone1 = setTimeout(function () {
            stone.push(new Stone());
        }, 4000);
        timeoutStone2 = setTimeout(function () {
            stone.push(new Stone());
        }, 8000);
        timeoutStone3 = setTimeout(function () {
            stone.push(new Stone());
        }, 12000);
        timeoutStone4 = setTimeout(function () {
            stone.push(new Stone());
        }, 16000);
        interval = setInterval(function () {
            gameBoard.road.draw();
            roadLane[0].draw(speed);
            roadLane[1].draw(speed);
            roadLane[2].draw(speed);
            roadLane[3].draw(speed);
            roadLane[4].draw(speed);
            roadLane[5].draw(speed);
            roadLane[6].draw(speed);
            if (typeof coin[0] === "object") coin[0].draw(gameBoard.car, gameBoard, speed);
            if (typeof coin[1] === "object") coin[1].draw(gameBoard.car, gameBoard, speed);
            if (typeof coin[2] === "object") coin[2].draw(gameBoard.car, gameBoard, speed);
            if (typeof coin[3] === "object") coin[3].draw(gameBoard.car, gameBoard, speed);
            if (typeof coin[4] === "object") coin[4].draw(gameBoard.car, gameBoard, speed);
            stone[0].draw(gameBoard.car, gameBoard, speed);
            if (typeof stone[1] === "object") stone[1].draw(gameBoard.car, gameBoard, speed);
            if (typeof stone[2] === "object") stone[2].draw(gameBoard.car, gameBoard, speed);
            if (typeof stone[3] === "object") stone[3].draw(gameBoard.car, gameBoard, speed);
            if (typeof stone[4] === "object") stone[4].draw(gameBoard.car, gameBoard, speed);
            gameBoard.car.draw();
            gameBoard.car.setSpeed(speed);
            gameBoard.checkCollision();
            gameBoard.getScore();
            speed += speed * 0.001;
        }, 50);
    }
    function reStart() {
        clearLoopRender();
        setTimeout(function(){
            roadBg.style.display = "none";
            startImg.style.display = "none";
        }, 50);
        // context.clearRect(0, 0, CW, CH);
        stone = [];
        coin = [];
        roadLane = [];
        speed = CH * 0.005;
        start();
    }
</script>
</body>
</html>